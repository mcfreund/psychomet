---
title: "Trial-level analyses: univariate means"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true

---


# intro


```{r setup, include = FALSE}

library(here)
library(here)
library(tidyr)
library(dplyr)
library(magrittr)
library(data.table)
library(abind)
library(doParallel)
library(foreach)
library(mikeutils)
library(progress)
library(ggplot2)
library(grid)
library(gridExtra)
library(cowplot)
library(viridis)
library(purrr)

theme_set(theme_half_open())

source(here("code", "_constants.R"))
source(here("code", "_atlases.R"))
source(here("code", "_funs.R"))
source(here("code", "_read_behav.R"))


fnames <- c(
  "network_errts" = here("out", "icc", "means-trials_schaefer-network07_resid-errts.RDS"),
  "network_wherr" = here("out", "icc", "means-trials_schaefer-network07_resid-wherr.RDS"),
  "parcel_errts"  = here("out", "icc", "means-trials_schaefer-parcel_resid-errts.RDS"),
  "parcel_wherr"  = here("out", "icc", "means-trials_schaefer-parcel_resid-wherr.RDS")
)

cols <- c("subj", "task", "run", "trial.num", "trial.type", "acc")
trialinfo <- behav %>% map(~ select(.x, all_of(cols))) %>% rbindlist

hi <- c("BX", "InCon", "RN")
lo <- c("BY", "Con", "NN")

```


# errts


```{r}

## network ----

d_network_errts <- readRDS(fnames["network_errts"])
d_network_errts %<>% rename(trial.num = trial)
d_network_errts %<>% merge(trialinfo, by = c("subj", "task", "run", "trial.num"))  ## bind just enough info

## get hilo per task:

# table(d_network_errts[is.na(value)]$subj, d_network_errts[is.na(value)]$task)
# table(d_network_errts[!is.na(value)]$subj, d_network_errts[!is.na(value)]$task)

d_network_errts <- d_network_errts[!is.na(value)]
d_network_errts$hilo <- as.character(NA)
d_network_errts[trial.type %in% hi]$hilo <- "hi"
d_network_errts[trial.type %in% lo]$hilo <- "lo"

d_network_errts_subj <- 
  d_network_errts[hilo %in% c("hi", "lo"), .(value = mean(value)), by = c("subj", "task", "roi", "hilo")]  ## aggregate
d_network_errts_subj <- dcast(d_network_errts_subj, subj + task + roi ~ hilo)  ## to wide
d_network_errts_subj[, hi_v_lo := hi - lo]  ## get contrast



## plot:

d_network_errts_subj %>%
  
  ggplot(aes(roi, hi_v_lo)) +
  
  geom_hline(yintercept = 0) +
  stat_summary(fun = "mean", geom = "col", width = 0.5, position = position_dodge(width = 0.5), fill = "grey60") +
  stat_summary(
    fun.data = "mean_cl_boot", geom = "errorbar", width = 0, size = 1.5, position = position_dodge(width = 0.5)
    ) +
  
  facet_grid(vars(task), scales = "free_y") +
  
  labs(y = "Mean hi vs lo contrast (b)", x = "Network (Schaefer 7)")



## parcel ----


d_parcel_errts <- readRDS(fnames["parcel_errts"])
d_parcel_errts %<>% rename(trial.num = trial)
d_parcel_errts %<>% merge(trialinfo, by = c("subj", "task", "run", "trial.num"))  ## bind just enough info

d_parcel_errts <- d_parcel_errts[!is.na(value)]
d_parcel_errts$hilo <- as.character(NA)
d_parcel_errts[trial.type %in% hi]$hilo <- "hi"
d_parcel_errts[trial.type %in% lo]$hilo <- "lo"

d_parcel_errts_subj <- 
  d_parcel_errts[hilo %in% c("hi", "lo"), .(value = mean(value)), by = c("subj", "task", "roi", "hilo")]  ## aggregate
d_parcel_errts_subj <- dcast(d_parcel_errts_subj, subj + task + roi ~ hilo)  ## to wide
d_parcel_errts_subj[, hi_v_lo := hi - lo]  ## get contrast




## plot MD parcels

d_parcel_errts_subj[roi %in% key_schaefer[schaefermd]$parcel] %>%
  
  ggplot(aes(task, hi_v_lo, fill = task)) +
  
  geom_hline(yintercept = 2) +
  stat_summary(fun = function(x) t.test(x)$statistic, geom = "col", width = 0.5, position = position_dodge(width = 0.5)) +

  facet_wrap(vars(roi)) +
  theme(legend.position = 'none', axis.text.x = element_blank()) +
  
  labs(y = "Mean hi vs lo contrast (t-stat)", x = "Task (alphabetical)")


## plot surfaces



```


```{r}

library(reticulate)

conda_create("r-reticulate")

# conda_install("r-reticulate", "scipy")
# conda_install("r-reticulate", "nipy")



```


```{python}


```

## vs GLM

## ...